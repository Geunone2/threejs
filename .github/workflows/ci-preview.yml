name: Preview CI

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

on:
  pull_request:
    branches: [develop]

jobs:
  project-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm run build

      - name: Test
        run: pnpm test
 
  deploy-to-vercel:
	  runs-on: ubuntu-latest
	  outputs:
	   statis: ${{ job.status }}
	   preview_url: ${{ steps.deploy-vercel.outputs.preview_url }}
	   current_time: ${{ steps.current-time.outputs.formattedTime }}
	  needs: project-build
	  steps:
	   - name: Checkout
	     uses: actions/checkout@v4
	   
	   - name: Setup node
	     uses: actions/setup-node@v4
	     with:
	      node-version: [20]
	      cache: pnpm
	      cache-dependency-path: pnpm-lock.yaml
	   
	   - name: Setup pnpm
	     uses: pnpm/action-setup@v4
	     with:
	      version: 10
	   
	   - name: Install dependencies
	     run: pnpm install
	     
	   - name: Deploy to Vercel
	     id: deploy-vercel
	     run: |
	       pnpm add --global vercel@latest
	       vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
	       vercel build --token=${{ secrets.VERCEL_TOKEN }}
	       vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} > vercel-output.txt
	       echo "preview_url=$(cat vercel-output.txt)" >> $GITHUB_OUTPUT
	       
	   - name: Get current Time
	     uses: josStorer/get-current-time@v2
	     id: current-time
	     with:
	      format: "YYYY년 MM월 DD일 HH시 mm분"
	      utcOffset: "+09:00"
	      
	      github-preview-comment:
    runs-on: ubuntu-latest
    needs: [deploy-to-vercel]
    steps:
      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: ${{ github.event.number }}
          message: |
            🧷 Preview: ${{ needs.deploy-to-vercel.outputs.preview_url }}
            ⏰ Update: ${{ needs.deploy-to-vercel.outputs.currnent_time }}
